===============================================================================
                            Mikoé‚®ç®±ç³»ç»Ÿæ•…éšœæ’é™¤æŒ‡å—
===============================================================================

ç‰ˆæœ¬: v1.0
æ›´æ–°æ—¶é—´: 2025-01-24
ä½œè€…: Miko Team (QQ: 2014131458)

===============================================================================
ç›®å½•
===============================================================================

1. å¸¸è§å¯åŠ¨é—®é¢˜
2. ç½‘ç»œè¿æ¥é—®é¢˜
3. æ•°æ®åº“é—®é¢˜
4. é‚®ä»¶åè®®é—®é¢˜
5. Webç•Œé¢é—®é¢˜
6. æ€§èƒ½é—®é¢˜
7. å®‰å…¨é—®é¢˜
8. é…ç½®é—®é¢˜
9. æ—¥å¿—åˆ†æ
10. ç³»ç»Ÿç›‘æ§

===============================================================================
1. å¸¸è§å¯åŠ¨é—®é¢˜
===============================================================================

1.1 ç«¯å£å ç”¨é—®é¢˜
--------------
**é—®é¢˜ç°è±¡**: å¯åŠ¨æ—¶æç¤º "bind: address already in use"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# WindowsæŸ¥çœ‹ç«¯å£å ç”¨
netstat -ano | findstr :8080
netstat -ano | findstr :25

# Linux/macOSæŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :8080
netstat -tlnp | grep 8080

# æ€æ­»å ç”¨è¿›ç¨‹
# Windows
taskkill /PID <è¿›ç¨‹ID> /F

# Linux/macOS
kill -9 <è¿›ç¨‹ID>
```

**é¢„é˜²æªæ–½**:
- ä¿®æ”¹config.yamlä¸­çš„ç«¯å£é…ç½®
- ä½¿ç”¨ä¸åŒçš„ç«¯å£å·
- æ£€æŸ¥å…¶ä»–é‚®ä»¶æœåŠ¡æ˜¯å¦åœ¨è¿è¡Œ

1.2 æƒé™é—®é¢˜
-----------
**é—®é¢˜ç°è±¡**: Linuxä¸‹æ— æ³•ç»‘å®š25ç«¯å£ï¼Œæç¤ºæƒé™ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ–¹æ³•1: ä½¿ç”¨sudoè¿è¡Œ
sudo ./miko-email

# æ–¹æ³•2: è®¾ç½®capabilities (æ¨è)
sudo setcap 'cap_net_bind_service=+ep' ./miko-email

# æ–¹æ³•3: ä½¿ç”¨éç‰¹æƒç«¯å£
# ä¿®æ”¹config.yamlï¼Œå°†SMTPç«¯å£æ”¹ä¸º2525
```

1.3 æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥
------------------
**é—®é¢˜ç°è±¡**:
- "database disk image is malformed"
- "unable to open database file"
- "database is locked"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
ls -la miko_email.db

# ä¿®å¤æƒé™
chmod 644 miko_email.db

# æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
sqlite3 miko_email.db "PRAGMA integrity_check;"

# å¦‚æœæ•°æ®åº“æŸåï¼Œé‡æ–°åˆå§‹åŒ–
rm miko_email.db
go run main.go  # ä¼šè‡ªåŠ¨åˆ›å»ºæ–°æ•°æ®åº“

# å¤‡ä»½å’Œæ¢å¤æ•°æ®åº“
cp miko_email.db miko_email.db.backup
sqlite3 miko_email.db ".backup backup.db"
```

1.4 Goæ¨¡å—ä¸‹è½½å¤±è´¥
-----------------
**é—®é¢˜ç°è±¡**:
- "go: module not found"
- "connection timeout"
- "checksum mismatch"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# è®¾ç½®Goä»£ç†
go env -w GOPROXY=https://goproxy.cn,direct
go env -w GOSUMDB=sum.golang.google.cn

# æ¸…ç†æ¨¡å—ç¼“å­˜
go clean -modcache

# é‡æ–°ä¸‹è½½ä¾èµ–
go mod download
go mod tidy

# éªŒè¯æ¨¡å—
go mod verify
```

1.5 é…ç½®æ–‡ä»¶é—®é¢˜
---------------
**é—®é¢˜ç°è±¡**:
- "config file not found"
- "invalid yaml format"
- "missing required config"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la config.yaml

# éªŒè¯YAMLæ ¼å¼
python -c "import yaml; yaml.safe_load(open('config.yaml'))"

# ä½¿ç”¨é»˜è®¤é…ç½®
cp config.yaml.example config.yaml

# æ£€æŸ¥é…ç½®é¡¹
grep -n "database:" config.yaml
grep -n "server:" config.yaml
```

===============================================================================
2. ç½‘ç»œè¿æ¥é—®é¢˜
===============================================================================

2.1 SMTPè¿æ¥é—®é¢˜
---------------
**é—®é¢˜ç°è±¡**:
- "connection refused"
- "connection timeout"
- "authentication failed"

**è¯Šæ–­æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep -E ':(25|587|465)'

# 2. æµ‹è¯•ç«¯å£è¿æ¥
telnet localhost 25
telnet localhost 587

# 3. æ£€æŸ¥é˜²ç«å¢™
# Windows
netsh advfirewall firewall show rule name="SMTP"

# Linux
sudo iptables -L | grep -E '(25|587|465)'
sudo firewall-cmd --list-ports
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¼€æ”¾é˜²ç«å¢™ç«¯å£
# Windows
netsh advfirewall firewall add rule name="SMTP" dir=in action=allow protocol=TCP localport=25
netsh advfirewall firewall add rule name="SMTP-587" dir=in action=allow protocol=TCP localport=587

# Linux (iptables)
sudo iptables -A INPUT -p tcp --dport 25 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 587 -j ACCEPT

# Linux (firewalld)
sudo firewall-cmd --permanent --add-port=25/tcp
sudo firewall-cmd --permanent --add-port=587/tcp
sudo firewall-cmd --reload
```

2.2 IMAP/POP3è¿æ¥é—®é¢˜
-------------------
**é—®é¢˜ç°è±¡**: é‚®ä»¶å®¢æˆ·ç«¯æ— æ³•è¿æ¥

**è¯Šæ–­æ­¥éª¤**:
```bash
# æµ‹è¯•IMAPè¿æ¥
telnet localhost 143
# è¾“å…¥: a1 LOGIN username password

# æµ‹è¯•POP3è¿æ¥
telnet localhost 110
# è¾“å…¥: USER username
# è¾“å…¥: PASS password
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ç«¯å£é…ç½®
- éªŒè¯ç”¨æˆ·åå¯†ç 
- æ£€æŸ¥é‚®ç®±çŠ¶æ€
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

2.3 Webç•Œé¢è®¿é—®é—®é¢˜
------------------
**é—®é¢˜ç°è±¡**:
- é¡µé¢æ— æ³•åŠ è½½
- é™æ€èµ„æº404
- APIè¯·æ±‚å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥WebæœåŠ¡ç«¯å£
curl -I http://localhost:8080

# æ£€æŸ¥é™æ€èµ„æºè·¯å¾„
ls -la web/static/

# æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶
ls -la web/templates/

# æŸ¥çœ‹è®¿é—®æ—¥å¿—
tail -f logs/access.log
```

===============================================================================
3. æ•°æ®åº“é—®é¢˜
===============================================================================

3.1 æ•°æ®åº“æŸå
-------------
**é—®é¢˜ç°è±¡**:
- "database disk image is malformed"
- "database corruption"
- æŸ¥è¯¢è¿”å›å¼‚å¸¸ç»“æœ

**è¯Šæ–­æ­¥éª¤**:
```bash
# æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
sqlite3 miko_email.db "PRAGMA integrity_check;"

# æ£€æŸ¥æ•°æ®åº“ç»Ÿè®¡
sqlite3 miko_email.db "PRAGMA stats;"

# æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯
sqlite3 miko_email.db ".dbinfo"
```

**ä¿®å¤æ–¹æ¡ˆ**:
```bash
# æ–¹æ³•1: å¯¼å‡ºé‡å»º
sqlite3 miko_email.db ".dump" > backup.sql
rm miko_email.db
sqlite3 miko_email.db < backup.sql

# æ–¹æ³•2: ä½¿ç”¨VACUUM
sqlite3 miko_email.db "VACUUM;"

# æ–¹æ³•3: é‡å»ºç´¢å¼•
sqlite3 miko_email.db "REINDEX;"
```

3.2 æ•°æ®åº“é”å®š
-------------
**é—®é¢˜ç°è±¡**: "database is locked"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥æ‰¾é”å®šè¿›ç¨‹
lsof miko_email.db

# å¼ºåˆ¶è§£é” (è°¨æ…ä½¿ç”¨)
fuser -k miko_email.db

# æ£€æŸ¥WALæ–‡ä»¶
ls -la miko_email.db*

# æ¸…ç†WALæ–‡ä»¶
sqlite3 miko_email.db "PRAGMA wal_checkpoint(FULL);"
```

3.3 æ€§èƒ½é—®é¢˜
-----------
**é—®é¢˜ç°è±¡**: æŸ¥è¯¢é€Ÿåº¦æ…¢ï¼Œå“åº”æ—¶é—´é•¿

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```sql
-- åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN QUERY PLAN SELECT * FROM emails WHERE mailbox_id = 1;

-- æ·»åŠ ç¼ºå¤±ç´¢å¼•
CREATE INDEX idx_emails_mailbox_type ON emails(mailbox_id, email_type);

-- ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
-- é¿å…SELECT *ï¼ŒåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
SELECT id, subject, from_address, received_at
FROM emails
WHERE mailbox_id = ? AND email_type = 'inbox'
ORDER BY received_at DESC
LIMIT 20;

-- ä½¿ç”¨VACUUMä¼˜åŒ–æ•°æ®åº“
VACUUM;

-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE;
```

3.4 æ•°æ®è¿ç§»é—®é¢˜
---------------
**é—®é¢˜ç°è±¡**: ç‰ˆæœ¬å‡çº§åæ•°æ®ç»“æ„ä¸å…¼å®¹

**è§£å†³æ–¹æ¡ˆ**:
```go
// æ•°æ®åº“è¿ç§»è„šæœ¬
func MigrateDatabase(db *sql.DB) error {
    migrations := []string{
        // v1.0 -> v1.1: æ·»åŠ DKIMå­—æ®µ
        `ALTER TABLE domains ADD COLUMN dkim_record TEXT;`,

        // v1.1 -> v1.2: æ·»åŠ é‚®ä»¶é™„ä»¶è¡¨
        `CREATE TABLE IF NOT EXISTS email_attachments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            email_id INTEGER NOT NULL,
            filename TEXT NOT NULL,
            content_type TEXT,
            size INTEGER NOT NULL,
            file_path TEXT NOT NULL,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (email_id) REFERENCES emails(id) ON DELETE CASCADE
        );`,

        // v1.2 -> v1.3: æ·»åŠ è½¬å‘ç»Ÿè®¡
        `ALTER TABLE email_forwards ADD COLUMN forward_count INTEGER DEFAULT 0;`,
    }

    for i, migration := range migrations {
        if _, err := db.Exec(migration); err != nil {
            return fmt.Errorf("migration %d failed: %v", i+1, err)
        }
    }

    return nil
}
```

===============================================================================
4. é‚®ä»¶åè®®é—®é¢˜
===============================================================================

4.1 SMTPå‘é€é—®é¢˜
---------------
**é—®é¢˜ç°è±¡**:
- é‚®ä»¶å‘é€å¤±è´¥
- è®¤è¯é”™è¯¯
- è¿æ¥è¶…æ—¶

**è¯Šæ–­æ­¥éª¤**:
```bash
# æ‰‹åŠ¨æµ‹è¯•SMTP
telnet localhost 25
HELO test.com
MAIL FROM: test@example.com
RCPT TO: user@domain.com
DATA
Subject: Test

Test message.
.
QUIT
```

**å¸¸è§é”™è¯¯åŠè§£å†³**:
```
é”™è¯¯: "550 5.7.1 Relay access denied"
è§£å†³: æ£€æŸ¥å‘ä»¶äººåŸŸåæ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­

é”™è¯¯: "535 5.7.8 Authentication failed"
è§£å†³: æ£€æŸ¥ç”¨æˆ·åå¯†ç ï¼Œç¡®è®¤é‚®ç®±çŠ¶æ€

é”™è¯¯: "552 5.3.4 Message size exceeds maximum"
è§£å†³: æ£€æŸ¥é‚®ä»¶å¤§å°é™åˆ¶é…ç½®

é”™è¯¯: "421 4.3.2 Service not available"
è§£å†³: æ£€æŸ¥æœåŠ¡å™¨è´Ÿè½½å’Œè¿æ¥æ•°é™åˆ¶
```

4.2 IMAPæ¥æ”¶é—®é¢˜
---------------
**é—®é¢˜ç°è±¡**: é‚®ä»¶å®¢æˆ·ç«¯æ— æ³•æ”¶å–é‚®ä»¶

**è¯Šæ–­æ­¥éª¤**:
```bash
# æ‰‹åŠ¨æµ‹è¯•IMAP
telnet localhost 143
a1 LOGIN username password
a2 LIST "" "*"
a3 SELECT INBOX
a4 FETCH 1 BODY[]
a5 LOGOUT
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥é‚®ç®±å¯†ç 
- éªŒè¯é‚®ç®±çŠ¶æ€
- æŸ¥çœ‹é‚®ä»¶æ•°é‡
- æ£€æŸ¥æƒé™è®¾ç½®

4.3 POP3ä¸‹è½½é—®é¢˜
---------------
**é—®é¢˜ç°è±¡**: é‚®ä»¶ä¸‹è½½å¤±è´¥æˆ–ä¸å®Œæ•´

**è¯Šæ–­æ­¥éª¤**:
```bash
# æ‰‹åŠ¨æµ‹è¯•POP3
telnet localhost 110
USER username
PASS password
STAT
LIST
RETR 1
QUIT
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥é‚®ä»¶æ ¼å¼
- éªŒè¯é™„ä»¶å¤„ç†
- æŸ¥çœ‹å­˜å‚¨ç©ºé—´
- æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§

===============================================================================
5. Webç•Œé¢é—®é¢˜
===============================================================================

5.1 é¡µé¢åŠ è½½é—®é¢˜
---------------
**é—®é¢˜ç°è±¡**:
- é¡µé¢ç©ºç™½
- æ ·å¼é”™ä¹±
- JavaScripté”™è¯¯

**è¯Šæ–­æ­¥éª¤**:
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. æŸ¥çœ‹Consoleé”™è¯¯ä¿¡æ¯
3. æ£€æŸ¥Networkè¯·æ±‚çŠ¶æ€
4. éªŒè¯é™æ€èµ„æºè·¯å¾„

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥é™æ€èµ„æº
ls -la web/static/css/
ls -la web/static/js/

# æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶
ls -la web/templates/

# éªŒè¯æ–‡ä»¶æƒé™
chmod -R 644 web/static/
chmod -R 644 web/templates/
```

5.2 ç™»å½•é—®é¢˜
-----------
**é—®é¢˜ç°è±¡**:
- ç™»å½•å¤±è´¥
- ä¼šè¯è¿‡æœŸ
- æƒé™ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç®¡ç†å‘˜è´¦å·
sqlite3 miko_email.db "SELECT * FROM admins;"

# é‡ç½®ç®¡ç†å‘˜å¯†ç 
sqlite3 miko_email.db "UPDATE admins SET password_hash = '<new_hash>' WHERE username = 'admin';"

# æ£€æŸ¥ä¼šè¯é…ç½®
grep -n "session" config.yaml
```

5.3 APIè¯·æ±‚é—®é¢˜
--------------
**é—®é¢˜ç°è±¡**:
- è¯·æ±‚è¶…æ—¶
- å“åº”æ ¼å¼é”™è¯¯
- è·¨åŸŸé—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// æ£€æŸ¥APIå“åº”
fetch('/api/mailboxes')
  .then(response => {
    console.log('Status:', response.status);
    console.log('Headers:', response.headers);
    return response.json();
  })
  .then(data => console.log('Data:', data))
  .catch(error => console.error('Error:', error));

// æ£€æŸ¥è·¨åŸŸé…ç½®
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹CORSé”™è¯¯
```

===============================================================================
6. æ€§èƒ½é—®é¢˜
===============================================================================

6.1 å“åº”é€Ÿåº¦æ…¢
-------------
**é—®é¢˜ç°è±¡**: é¡µé¢åŠ è½½æ…¢ï¼ŒAPIå“åº”æ—¶é—´é•¿

**è¯Šæ–­æ­¥éª¤**:
```bash
# æ£€æŸ¥ç³»ç»Ÿèµ„æº
top
htop
free -h
df -h

# æ£€æŸ¥æ•°æ®åº“æ€§èƒ½
sqlite3 miko_email.db "PRAGMA stats;"

# åˆ†ææ…¢æŸ¥è¯¢
# åœ¨ä»£ç ä¸­æ·»åŠ æŸ¥è¯¢æ—¶é—´æ—¥å¿—
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```sql
-- æ·»åŠ æ•°æ®åº“ç´¢å¼•
CREATE INDEX idx_emails_mailbox_received ON emails(mailbox_id, received_at);
CREATE INDEX idx_emails_type_read ON emails(email_type, is_read);

-- ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
-- ä½¿ç”¨LIMITé™åˆ¶ç»“æœæ•°é‡
SELECT * FROM emails WHERE mailbox_id = ? ORDER BY received_at DESC LIMIT 20;

-- ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢
SELECT * FROM emails WHERE mailbox_id = ? ORDER BY received_at DESC LIMIT 20 OFFSET ?;
```

6.2 å†…å­˜ä½¿ç”¨è¿‡é«˜
---------------
**é—®é¢˜ç°è±¡**: å†…å­˜å ç”¨æŒç»­å¢é•¿

**è¯Šæ–­æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
ps aux | grep miko-email

# Goå†…å­˜åˆ†æ
go tool pprof http://localhost:6060/debug/pprof/heap

# æŸ¥çœ‹goroutine
go tool pprof http://localhost:6060/debug/pprof/goroutine
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```go
// åŠæ—¶å…³é—­èµ„æº
defer rows.Close()
defer file.Close()

// ä½¿ç”¨å¯¹è±¡æ± 
var emailPool = sync.Pool{
    New: func() interface{} {
        return &models.Email{}
    },
}

// æ§åˆ¶goroutineæ•°é‡
semaphore := make(chan struct{}, 100) // æœ€å¤š100ä¸ªå¹¶å‘
```

6.3 ç£ç›˜ç©ºé—´é—®é¢˜
---------------
**é—®é¢˜ç°è±¡**: ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œé‚®ä»¶å­˜å‚¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
df -h

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
find logs/ -name "*.log" -mtime +30 -delete

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf /tmp/miko-email-*

# å‹ç¼©æ—§é‚®ä»¶
sqlite3 miko_email.db "DELETE FROM emails WHERE received_at < date('now', '-1 year');"

# æ•°æ®åº“VACUUM
sqlite3 miko_email.db "VACUUM;"
```

===============================================================================
7. å®‰å…¨é—®é¢˜
===============================================================================

7.1 è®¤è¯å®‰å…¨
-----------
**é—®é¢˜ç°è±¡**:
- æš´åŠ›ç ´è§£æ”»å‡»
- ä¼šè¯åŠ«æŒ
- æƒé™ç»•è¿‡

**é˜²æŠ¤æªæ–½**:
```go
// ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
type LoginAttempt struct {
    IP        string
    Count     int
    LastTry   time.Time
    Blocked   bool
}

var loginAttempts = make(map[string]*LoginAttempt)

func checkLoginAttempt(ip string) bool {
    attempt, exists := loginAttempts[ip]
    if !exists {
        loginAttempts[ip] = &LoginAttempt{
            IP:      ip,
            Count:   0,
            LastTry: time.Now(),
        }
        return true
    }

    // æ£€æŸ¥æ˜¯å¦è¢«é˜»æ­¢
    if attempt.Blocked && time.Since(attempt.LastTry) < 15*time.Minute {
        return false
    }

    // é‡ç½®è®¡æ•°å™¨
    if time.Since(attempt.LastTry) > 5*time.Minute {
        attempt.Count = 0
        attempt.Blocked = false
    }

    return true
}
```

7.2 æ•°æ®å®‰å…¨
-----------
**é—®é¢˜ç°è±¡**:
- æ•°æ®æ³„éœ²
- SQLæ³¨å…¥
- XSSæ”»å‡»

**é˜²æŠ¤æªæ–½**:
```go
// SQLæ³¨å…¥é˜²æŠ¤ - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
func (r *UserRepository) GetByUsername(username string) (*models.User, error) {
    // æ­£ç¡®æ–¹å¼
    row := r.db.QueryRow("SELECT * FROM users WHERE username = ?", username)

    // é”™è¯¯æ–¹å¼ - å®¹æ˜“SQLæ³¨å…¥
    // row := r.db.QueryRow(fmt.Sprintf("SELECT * FROM users WHERE username = '%s'", username))
}

// XSSé˜²æŠ¤ - è¾“å‡ºè½¬ä¹‰
import "html/template"

func renderTemplate(w http.ResponseWriter, tmpl string, data interface{}) {
    t := template.Must(template.ParseFiles(tmpl))
    t.Execute(w, data) // è‡ªåŠ¨è½¬ä¹‰HTML
}
```

7.3 ç½‘ç»œå®‰å…¨
-----------
**é—®é¢˜ç°è±¡**:
- DDoSæ”»å‡»
- ç«¯å£æ‰«æ
- æ¶æ„è¯·æ±‚

**é˜²æŠ¤æªæ–½**:
```go
// é™æµä¸­é—´ä»¶
func RateLimitMiddleware() gin.HandlerFunc {
    limiter := rate.NewLimiter(rate.Every(time.Minute), 60) // æ¯åˆ†é’Ÿ60æ¬¡

    return func(c *gin.Context) {
        if !limiter.Allow() {
            c.JSON(http.StatusTooManyRequests, gin.H{
                "success": false,
                "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•",
            })
            c.Abort()
            return
        }
        c.Next()
    }
}

// IPç™½åå•ä¸­é—´ä»¶
func IPWhitelistMiddleware(allowedIPs []string) gin.HandlerFunc {
    return func(c *gin.Context) {
        clientIP := c.ClientIP()

        allowed := false
        for _, ip := range allowedIPs {
            if clientIP == ip || strings.HasPrefix(clientIP, ip) {
                allowed = true
                break
            }
        }

        if !allowed {
            c.JSON(http.StatusForbidden, gin.H{
                "success": false,
                "message": "è®¿é—®è¢«æ‹’ç»",
            })
            c.Abort()
            return
        }

        c.Next()
    }
}
```

===============================================================================
8. é…ç½®é—®é¢˜
===============================================================================

8.1 é‚®ä»¶é…ç½®é—®é¢˜
---------------
**é—®é¢˜ç°è±¡**:
- é‚®ä»¶å‘é€å¤±è´¥
- DNSè§£æé”™è¯¯
- DKIMéªŒè¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```yaml
# æ£€æŸ¥é‚®ä»¶é…ç½®
email:
  max_size: 25                    # é‚®ä»¶å¤§å°é™åˆ¶(MB)
  max_mailboxes_per_user: 10      # æ¯ç”¨æˆ·æœ€å¤§é‚®ç®±æ•°
  retention_days: 0               # é‚®ä»¶ä¿ç•™å¤©æ•°(0=æ°¸ä¹…)
  enable_forwarding: true         # å¯ç”¨è½¬å‘åŠŸèƒ½

# æ£€æŸ¥SMTPå‘é€é…ç½®
smtp_sender:
  host: smtp.163.com              # SMTPæœåŠ¡å™¨
  port: 465                       # SMTPç«¯å£
  username: your-email@163.com    # å‘é€è´¦å·
  password: your-password         # å‘é€å¯†ç 
  secure: ssl                     # åŠ å¯†æ–¹å¼
  from_name: "æ€.å‡¡é‚®ç®±ç³»ç»Ÿ"       # å‘ä»¶äººåç§°
```

8.2 åŸŸåé…ç½®é—®é¢˜
---------------
**é—®é¢˜ç°è±¡**:
- åŸŸåéªŒè¯å¤±è´¥
- DNSè®°å½•é”™è¯¯
- é‚®ä»¶æŠ•é€’å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥DNSè®°å½•
nslookup -type=MX yourdomain.com
nslookup -type=A yourdomain.com
nslookup -type=TXT yourdomain.com

# éªŒè¯SPFè®°å½•
dig TXT yourdomain.com | grep "v=spf1"

# éªŒè¯DKIMè®°å½•
dig TXT default._domainkey.yourdomain.com

# éªŒè¯DMARCè®°å½•
dig TXT _dmarc.yourdomain.com
```

**æ­£ç¡®çš„DNSé…ç½®ç¤ºä¾‹**:
```
# Aè®°å½•
yourdomain.com.     IN  A       192.168.1.100

# MXè®°å½•
yourdomain.com.     IN  MX  10  mail.yourdomain.com.

# SPFè®°å½•
yourdomain.com.     IN  TXT     "v=spf1 ip4:192.168.1.100 ~all"

# DKIMè®°å½•
default._domainkey.yourdomain.com. IN TXT "v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC..."

# DMARCè®°å½•
_dmarc.yourdomain.com. IN TXT "v=DMARC1; p=quarantine; rua=mailto:dmarc@yourdomain.com"
```

8.3 SSL/TLSé…ç½®é—®é¢˜
------------------
**é—®é¢˜ç°è±¡**:
- SSLè¯ä¹¦éªŒè¯å¤±è´¥
- åŠ å¯†è¿æ¥å»ºç«‹å¤±è´¥
- è¯ä¹¦è¿‡æœŸ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ (æµ‹è¯•ç”¨)
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# æ£€æŸ¥è¯ä¹¦ä¿¡æ¯
openssl x509 -in cert.pem -text -noout

# éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§
openssl verify cert.pem

# æµ‹è¯•SSLè¿æ¥
openssl s_client -connect localhost:465 -servername yourdomain.com
```

===============================================================================
9. æ—¥å¿—åˆ†æ
===============================================================================

9.1 æ—¥å¿—é…ç½®
-----------
```yaml
logging:
  level: info                     # æ—¥å¿—çº§åˆ«: debug/info/warn/error
  to_file: true                   # æ˜¯å¦è¾“å‡ºåˆ°æ–‡ä»¶
  file_path: ./logs/app.log       # æ—¥å¿—æ–‡ä»¶è·¯å¾„
  access_log: true                # æ˜¯å¦è®°å½•è®¿é—®æ—¥å¿—
  max_size: 100                   # æ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°(MB)
  max_backups: 10                 # ä¿ç•™çš„æ—¥å¿—æ–‡ä»¶æ•°é‡
  max_age: 30                     # æ—¥å¿—æ–‡ä»¶ä¿ç•™å¤©æ•°
```

9.2 æ—¥å¿—åˆ†ææŠ€å·§
---------------
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/app.log

# è¿‡æ»¤é”™è¯¯æ—¥å¿—
grep "ERROR" logs/app.log

# ç»Ÿè®¡é”™è¯¯ç±»å‹
grep "ERROR" logs/app.log | awk '{print $4}' | sort | uniq -c

# åˆ†æè®¿é—®æ—¥å¿—
awk '{print $1}' logs/access.log | sort | uniq -c | sort -nr | head -10

# æŸ¥æ‰¾ç‰¹å®šæ—¶é—´æ®µçš„æ—¥å¿—
sed -n '/2024-01-01 10:00/,/2024-01-01 11:00/p' logs/app.log
```

9.3 å¸¸è§æ—¥å¿—é”™è¯¯
---------------
```
é”™è¯¯: "database disk image is malformed"
åŸå› : æ•°æ®åº“æ–‡ä»¶æŸå
è§£å†³: æ¢å¤æ•°æ®åº“å¤‡ä»½æˆ–é‡æ–°åˆå§‹åŒ–

é”™è¯¯: "connection refused"
åŸå› : æœåŠ¡æœªå¯åŠ¨æˆ–ç«¯å£è¢«å ç”¨
è§£å†³: æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œç«¯å£é…ç½®

é”™è¯¯: "authentication failed"
åŸå› : ç”¨æˆ·åå¯†ç é”™è¯¯æˆ–è´¦å·è¢«ç¦ç”¨
è§£å†³: éªŒè¯è´¦å·ä¿¡æ¯å’ŒçŠ¶æ€

é”™è¯¯: "file not found"
åŸå› : é™æ€èµ„æºæˆ–æ¨¡æ¿æ–‡ä»¶ç¼ºå¤±
è§£å†³: æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™

é”™è¯¯: "panic: runtime error"
åŸå› : ç¨‹åºè¿è¡Œæ—¶é”™è¯¯
è§£å†³: æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œä¿®å¤ä»£ç é—®é¢˜
```

===============================================================================
10. ç³»ç»Ÿç›‘æ§
===============================================================================

10.1 ç›‘æ§æŒ‡æ ‡
------------
**ç³»ç»ŸæŒ‡æ ‡**
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- ç£ç›˜ä½¿ç”¨ç‡
- ç½‘ç»œæµé‡

**åº”ç”¨æŒ‡æ ‡**
- è¯·æ±‚å“åº”æ—¶é—´
- é”™è¯¯ç‡
- å¹¶å‘è¿æ¥æ•°
- é‚®ä»¶å¤„ç†é‡

**ä¸šåŠ¡æŒ‡æ ‡**
- ç”¨æˆ·æ³¨å†Œæ•°
- é‚®ç®±åˆ›å»ºæ•°
- é‚®ä»¶å‘é€é‡
- æ´»è·ƒç”¨æˆ·æ•°

10.2 ç›‘æ§å·¥å…·
------------
**ç³»ç»Ÿç›‘æ§**
```bash
# ç³»ç»Ÿèµ„æºç›‘æ§
htop
iotop
nethogs

# è¿›ç¨‹ç›‘æ§
ps aux | grep miko-email
pstree -p $(pgrep miko-email)
```

**åº”ç”¨ç›‘æ§**
```go
// æ·»åŠ ç›‘æ§ç«¯ç‚¹
func setupMonitoring(router *gin.Engine) {
    router.GET("/health", func(c *gin.Context) {
        c.JSON(http.StatusOK, gin.H{
            "status":    "healthy",
            "timestamp": time.Now(),
            "version":   "v1.0.0",
        })
    })

    router.GET("/metrics", func(c *gin.Context) {
        c.JSON(http.StatusOK, gin.H{
            "uptime":      time.Since(startTime).Seconds(),
            "requests":    requestCount,
            "errors":      errorCount,
            "connections": activeConnections,
        })
    })
}
```

10.3 å‘Šè­¦é…ç½®
------------
**é‚®ä»¶å‘Šè­¦**
```go
func sendAlert(level, message string) {
    if level == "critical" {
        // å‘é€ç´§æ€¥å‘Šè­¦é‚®ä»¶
        sendEmail("admin@yourdomain.com", "ç³»ç»Ÿå‘Šè­¦", message)
    }

    // è®°å½•å‘Šè­¦æ—¥å¿—
    log.Printf("[ALERT] %s: %s", level, message)
}

// ç›‘æ§æ£€æŸ¥
func healthCheck() {
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    if err := db.Ping(); err != nil {
        sendAlert("critical", "æ•°æ®åº“è¿æ¥å¤±è´¥: " + err.Error())
    }

    // æ£€æŸ¥ç£ç›˜ç©ºé—´
    if diskUsage > 90 {
        sendAlert("warning", fmt.Sprintf("ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: %d%%", diskUsage))
    }

    // æ£€æŸ¥å†…å­˜ä½¿ç”¨
    if memoryUsage > 80 {
        sendAlert("warning", fmt.Sprintf("å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: %d%%", memoryUsage))
    }
}
```

===============================================================================
11. å¤‡ä»½å’Œæ¢å¤
===============================================================================

11.1 æ•°æ®å¤‡ä»½
------------
**è‡ªåŠ¨å¤‡ä»½è„šæœ¬**
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/miko-email"
DATE=$(date +%Y%m%d_%H%M%S)
DB_FILE="miko_email.db"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
sqlite3 $DB_FILE ".backup $BACKUP_DIR/miko_email_$DATE.db"

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp config.yaml $BACKUP_DIR/config_$DATE.yaml

# å¤‡ä»½DKIMå¯†é’¥
tar -czf $BACKUP_DIR/dkim_keys_$DATE.tar.gz dkim_keys/

# æ¸…ç†æ—§å¤‡ä»½ (ä¿ç•™30å¤©)
find $BACKUP_DIR -name "*.db" -mtime +30 -delete
find $BACKUP_DIR -name "*.yaml" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
```

**å®šæ—¶å¤‡ä»½ (crontab)**
```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /path/to/backup.sh

# æ¯å°æ—¶å¢é‡å¤‡ä»½
0 * * * * sqlite3 miko_email.db ".backup /backup/incremental/miko_email_$(date +\%H).db"
```

11.2 æ•°æ®æ¢å¤
------------
**æ¢å¤æ­¥éª¤**
```bash
# 1. åœæ­¢æœåŠ¡
sudo systemctl stop miko-email

# 2. å¤‡ä»½å½“å‰æ•°æ®
cp miko_email.db miko_email.db.broken

# 3. æ¢å¤æ•°æ®åº“
cp /backup/miko-email/miko_email_20240101_020000.db miko_email.db

# 4. æ¢å¤é…ç½®
cp /backup/miko-email/config_20240101_020000.yaml config.yaml

# 5. æ¢å¤DKIMå¯†é’¥
tar -xzf /backup/miko-email/dkim_keys_20240101_020000.tar.gz

# 6. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
sqlite3 miko_email.db "PRAGMA integrity_check;"

# 7. é‡å¯æœåŠ¡
sudo systemctl start miko-email
```

===============================================================================
12. å¸¸ç”¨å‘½ä»¤
===============================================================================

12.1 ç³»ç»Ÿç®¡ç†å‘½ä»¤
---------------
```bash
# æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
systemctl status miko-email

# é‡å¯æœåŠ¡
systemctl restart miko-email

# æŸ¥çœ‹æ—¥å¿—
journalctl -u miko-email -f

# æ£€æŸ¥é…ç½®
./miko-email --check-config

# æ•°æ®åº“ç»´æŠ¤
sqlite3 miko_email.db "VACUUM;"
sqlite3 miko_email.db "ANALYZE;"
```

12.2 å¼€å‘è°ƒè¯•å‘½ä»¤
---------------
```bash
# ç¼–è¯‘å’Œè¿è¡Œ
go build -o miko-email main.go
./miko-email

# çƒ­é‡è½½å¼€å‘
go install github.com/cosmtrek/air@latest
air

# ä»£ç æ£€æŸ¥
go vet ./...
golint ./...
go fmt ./...

# è¿è¡Œæµ‹è¯•
go test ./...
go test -v ./internal/services/...
go test -cover ./...
```

12.3 æ•°æ®åº“ç®¡ç†å‘½ä»¤
-----------------
```bash
# è¿æ¥æ•°æ®åº“
sqlite3 miko_email.db

# æŸ¥çœ‹è¡¨ç»“æ„
.schema users
.schema domains
.schema mailboxes

# æŸ¥çœ‹æ•°æ®
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM mailboxes;
SELECT COUNT(*) FROM emails;

# æ¸…ç†æ•°æ®
DELETE FROM emails WHERE received_at < date('now', '-1 year');
DELETE FROM email_attachments WHERE email_id NOT IN (SELECT id FROM emails);

# ä¼˜åŒ–æ•°æ®åº“
VACUUM;
ANALYZE;
```

===============================================================================
ç´§æ€¥è”ç³»æ–¹å¼
===============================================================================

å¦‚é‡åˆ°ç´§æ€¥é—®é¢˜æ— æ³•è§£å†³ï¼Œè¯·è”ç³»:

ğŸ“ æŠ€æœ¯æ”¯æŒ: QQ 2014131458
ğŸ“§ é‚®ä»¶æ”¯æŒ: 2014131458@qq.com
ğŸŒ é¡¹ç›®åœ°å€: https://github.com/your-repo/miko-email
ğŸ“– åœ¨çº¿æ–‡æ¡£: https://docs.miko-email.com

â° æ”¯æŒæ—¶é—´: å·¥ä½œæ—¥ 9:00-18:00 (UTC+8)
ğŸš¨ ç´§æ€¥é—®é¢˜: 24å°æ—¶å†…å“åº”

===============================================================================